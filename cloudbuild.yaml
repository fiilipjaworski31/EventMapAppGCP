steps:
  # --- Backend Steps (Twoja sprawdzona wersja) ---
  # 1. Zbuduj obraz kontenera Docker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/map-events-api:${_TAG}', './backend']
    id: 'Build Backend Image'

  # 2. Wyślij obraz do Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/map-events-api:${_TAG}']
    id: 'Push Backend Image'

  # 3. Wdróż nową wersję na Cloud Run (Twoja sprawdzona komenda)
  - name: 'gcr.io/google.com/cloudsdktool/google-cloud-cli:slim'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'map-events-api'
      - '--image=${_REGION}-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/map-events-api:${_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--service-account=ci-cd-service-account@${PROJECT_ID}.iam.gserviceaccount.com'
      - '--add-cloudsql-instances=healthy-result-469611-e9:europe-central2:event-map-db' # <-- Przywrócona flaga
    id: 'Deploy to Cloud Run'

  # --- Frontend Steps (Z bezpiecznymi sekretami) ---
  # 4. Zainstaluj zależności frontendu
  - name: 'gcr.io/cloud-builders/npm'
    id: 'Install Frontend Dependencies'
    dir: 'frontend'
    args: ['install']

  # 5. Zbuduj aplikację frontendową, wstrzykując sekrety
  - name: 'gcr.io/cloud-builders/npm'
    id: 'Build Frontend'
    dir: 'frontend'
    args: ['run', 'build']
    secretEnv: ['VITE_API_URL', 'VITE_GOOGLE_MAPS_API_KEY', 'VITE_GOOGLE_MAPS_ID']

  # 6. Wdróż frontend na Firebase Hosting
  - name: 'gcr.io/cloud-builders/npm'
    id: 'Deploy to Firebase Hosting'
    dir: 'frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'npm install -g firebase-tools && firebase deploy --only hosting --project $PROJECT_ID --non-interactive'

# Definiujemy, które sekrety z Secret Managera mają być dostępne
availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/VITE_API_URL/versions/latest
    env: 'VITE_API_URL'
  - versionName: projects/$PROJECT_ID/secrets/VITE_GOOGLE_MAPS_API_KEY/versions/latest
    env: 'VITE_GOOGLE_MAPS_API_KEY'
  - versionName: projects/$PROJECT_ID/secrets/VITE_GOOGLE_MAPS_ID/versions/latest
    env: 'VITE_GOOGLE_MAPS_ID'

# Domyślne wartości zmiennych
substitutions:
  _REGION: 'europe-central2'
  _TAG: 'latest' 

options:
  logging: CLOUD_LOGGING_ONLY